name: PolyAPI Deployment Action (Python)
description: 'This GitHub Action automates the deployment process for all PolyAPI deployables in your Python application.'
branding:
  icon: 'upload-cloud'
  color: 'blue'

inputs:
  poly_api_key:
    description: 'The API key for Poly.'
    required: true
  poly_api_base_url:
    description: 'The base URL for the deploy target Poly instance.'
    required: true
  do_checkout:
    description: 'Whether the action should run its own actions/checkout step.'
    required: false
    default: 'true'
  working_directory:
    description: 'Path to run Poly commands in'
    required: false
    default: '.'

runs:
  using: composite
  steps:
    - name: Validate working_directory
      shell: bash
      run: |
        if [ ! -d "${{ inputs.working_directory }}" ]; then
          echo "working_directory '${{ inputs.working_directory }}' does not exist or is not a directory."
          exit 1
        fi

    - name: Check inputs
      shell: bash
      env:
        POLY_API_KEY: ${{ inputs.poly_api_key }}
        POLY_API_BASE_URL: ${{ inputs.poly_api_base_url }}
      run: |
        cd "${{ inputs.working_directory }}"
        if [ -z "${POLY_API_KEY:-}" ]; then
          echo "poly_api_key is not defined. Did you forget to set it up as a secret or forget to pass it in?"
          exit 1
        fi
        if [ -z "${POLY_API_BASE_URL:-}" ]; then
          echo "poly_api_base_url is not defined. Did you forget to set it up as a secret or forget to pass it in?"
          exit 1
        fi

    - name: Checkout code
      if: ${{ inputs.do_checkout == 'true' }}
      uses: actions/checkout@v4

    - name: Poly pre-check
      shell: bash
      run: |
        cd "${{ inputs.working_directory }}"
        if ! grep -q 'polyapi' requirements.txt; then
          echo "Please add the PolyAPI client to your requirements.txt file."
          exit 1
        fi

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        check-latest: true

    - name: Restore cached dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
        key: "${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}"
        restore-keys: |
          "${{ runner.os }}-pip-"

    - name: Install dependencies
      shell: bash
      run: |
        cd "${{ inputs.working_directory }}"
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Locate PolyAPI installation directory
      id: poly_dir
      shell: bash
      run: |
        cd "${{ inputs.working_directory }}"
        POLY_DIR=$(python -c "import polyapi; import os; print(os.path.dirname(polyapi.__file__))")
        echo "poly_dir=$POLY_DIR" >> $GITHUB_ENV

    - name: Setup and generate PolyAPI
      id: poly_setup
      shell: bash
      env:
        POLY_API_KEY: ${{ inputs.poly_api_key }}
        POLY_API_BASE_URL: ${{ inputs.poly_api_base_url }}
      run: |
        set -euo pipefail
        echo "::add-mask::${POLY_API_KEY}"
        cd "${{ inputs.working_directory }}"
        python -m polyapi setup
        python -m polyapi generate --no-types
        rm -f .polyapi/config.json ~/.polyapi/config.json 2>/dev/null || true

    - name: Restore cached PolyAPI deployments
      uses: actions/cache@v4
      with:
        path: | 
          ${{ env.poly_dir }}/cached_deployables
          ${{ env.poly_dir }}/deployments_revision
        key: "${{ runner.os }}-poly-deployables-${{ inputs.poly_api_base_url }}-${{inputs.working_directory}}"
        restore-keys: |
          "${{ runner.os }}-poly-deployables-"

    - name: Deploy
      id: deploy
      shell: bash
      env:
        POLY_API_KEY: ${{ inputs.poly_api_key }}
        POLY_API_BASE_URL: ${{ inputs.poly_api_base_url }}
      run: |
        set -euo pipefail
        echo "::add-mask::${POLY_API_KEY}"
        cd "${{ inputs.working_directory }}"
        python -m polyapi sync
        rm -f .polyapi/config.json ~/.polyapi/config.json 2>/dev/null || true

    - name: Cache PolyAPI deployments
      uses: actions/cache@v4
      with:
        path: | 
          ${{ env.poly_dir }}/cached_deployables
          ${{ env.poly_dir }}/deployments_revision
        key: "${{ runner.os }}-poly-deployables-${{ inputs.poly_api_base_url }}-${{inputs.working_directory}}"
        restore-keys: |
          "${{ runner.os }}-poly-deployables-"

    - name: Commit deployment receipts
      shell: bash
      run: |
        cd "${{ inputs.working_directory }}"
        git config --global user.name 'PolyAPI Deployment Bot'
        git config --global user.email 'poly-deployments@polyapi.io'
        git add .
        if ! git diff-index --quiet HEAD; then
          git commit -m "PolyAPI Deployment" --no-verify
        else
          echo "No changes to commit."
        fi

    - name: Push changes
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ github.token }}
        branch: ${{ github.ref_name }}
